<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GraphHopper Directions</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/mithril/0.2.5/mithril.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
</head>
<body>
<script>



    var graphHopper = {
        Request: function(data) {

        }
    };

    var Map = {
        view: function(controller, args) {
            return m("div", {style: "height:800px", config: function(element, isInitialized, context) {
                context.retain = true;
                if (!isInitialized) {
                    Map.view.mymap = L.map(element);
                    L.tileLayer('http://a.tile2.opencyclemap.org/transport/{z}/{x}/{y}.png', {
                        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                        maxZoom: 18
                    }).addTo(Map.view.mymap);
                    var origin = L.marker(routePlanner.vm.origin(),{draggable: true});
                    origin.on('dragend', function() {
                        routePlanner.vm.origin(origin.getLatLng());
                        routePlanner.vm.reRoute();
                    });
                    var destination = L.marker(routePlanner.vm.destination(),{draggable: true});
                    destination.on('dragend', function() {
                        routePlanner.vm.destination(destination.getLatLng());
                        routePlanner.vm.reRoute();
                    });
                    var inputPoints = L.featureGroup([origin, destination]);
                    inputPoints.addTo(Map.view.mymap);
                    Map.view.responseLayer = L.featureGroup().addTo(Map.view.mymap);
                    Map.view.mymap.fitBounds(inputPoints.getBounds());
                }
                Map.view.responseLayer.clearLayers();
                if (args.response() != null) {
                    L.geoJson(args.response().paths[0].points).addTo(Map.view.responseLayer);
                }
            }});
        }
    };


    var routePlanner = {
        vm: {
            init: function() {
                routePlanner.vm.origin = m.prop(L.latLng(m.route.param("point")[0].split(',')));
                routePlanner.vm.destination = m.prop(L.latLng(m.route.param("point")[1].split(',')));

                routePlanner.vm.doRequest = function() {
                    return m.request({method: "GET", url: "http://localhost:8990/route?point="+routePlanner.vm.origin().lat+","+routePlanner.vm.origin().lng+"&point="+routePlanner.vm.destination().lat+","+routePlanner.vm.destination().lng+"&locale=en-US&vehicle=pt&weighting=fastest&elevation=false&earliestDepartureTime=46200&use_miles=false&points_encoded=false"});
                }
                routePlanner.vm.reRoute = function() {
                    m.route("/directions?point="+routePlanner.vm.origin().lat+","+routePlanner.vm.origin().lng+"&point="+routePlanner.vm.destination().lat+","+routePlanner.vm.destination().lng)
                }
            }
        },
        controller: function() {
            routePlanner.vm.init();
            return {
                response: routePlanner.vm.doRequest()
            }
        },
        view: function(controller) {
            return m("html", [
                m("body", [
                    m("div", [
                        m("table", [
                            m("tr", [
                                m("td", [
                                    m("input", {onchange: m.withAttr("value", routePlanner.vm.origin), value:routePlanner.vm.origin()})
                                ]),
                                m("td", "origin")
                            ]),
                            m("tr", [
                                m("td", [
                                    m("input", {onchange: m.withAttr("value", routePlanner.vm.destination), value:routePlanner.vm.destination()})
                                ]),
                                m("td", "destination")
                            ])
                        ]),
                        m("button", {onclick:  routePlanner.vm.reRoute}, "Get route")
                    ]),
                    m.component(Map, {response: controller.response}),
                    m("div", JSON.stringify(controller.response()))
                ])
            ]);
        }
    };

    m.route(document.body, "/directions?point=52.5141,13.4963&point=52.5137,13.4355", {
        "/directions": routePlanner,
    });
</script>
</body>
</html>